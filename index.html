<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>装修费用计算器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .total-amount {
            font-size: 2.2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .sync-status {
            font-size: 12px;
            margin-top: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.3s;
            min-height: 20px;
        }

        .sync-status.success {
            background: rgba(72, 187, 120, 0.2);
            color: #38a169;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }

        .sync-status.error {
            background: rgba(229, 62, 62, 0.2);
            color: #e53e3e;
            border: 1px solid rgba(229, 62, 62, 0.3);
        }

        .sync-status.warning {
            background: rgba(237, 137, 54, 0.2);
            color: #d69e2e;
            border: 1px solid rgba(237, 137, 54, 0.3);
        }

        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            z-index: 1001;
        }

        .sync-indicator.online {
            background: #48bb78;
            box-shadow: 0 0 10px rgba(72, 187, 120, 0.5);
        }

        .sync-indicator.offline {
            background: #e53e3e;
            box-shadow: 0 0 10px rgba(229, 62, 62, 0.5);
        }

        .sync-indicator.syncing {
            background: #3182ce;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .category-tabs {
            display: flex;
            background: #f8f9fa;
            overflow-x: auto;
            padding: 0 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .category-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            min-height: 60vh;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .category-summary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .category-summary h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .category-total {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .add-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-input {
            width: 80px !important;
            text-align: center;
            padding: 10px !important;
        }
        
        .add-btn {
            width: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-btn:active {
            transform: scale(0.98);
        }
        
        .items-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .item:active {
            transform: scale(0.98);
        }
        
        .item-content {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            flex: 1;
            margin-right: 10px;
        }
        
        .item-name {
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 5px;
            word-break: break-all;
            cursor: pointer;
        }
        
        .item-name:hover {
            color: #667eea;
        }
        
        .item-details {
            font-size: 12px;
            color: #666;
        }
        
        .item-price-section {
            text-align: right;
        }
        
        .item-price {
            font-weight: bold;
            color: #2b6cb0;
            font-size: 16px;
            cursor: pointer;
        }
        
        .item-price:hover {
            color: #667eea;
        }
        
        .item-total {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .item-actions {
            background: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-quantity {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .edit-quantity button {
            background: #667eea;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .edit-quantity span {
            min-width: 30px;
            text-align: center;
            font-size: 14px;
        }
        
        .delete-btn, .edit-btn {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .edit-btn {
            background: #3182ce;
        }
        
        .delete-btn:active {
            background: #c53030;
        }
        
        .edit-btn:active {
            background: #2c5282;
        }
        
        .stats-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .export-section {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
            border-top: 1px solid #e2e8f0;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #805ad5, #9f7aea);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .export-btn:active {
            transform: scale(0.95);
        }
        
        .backup-btn {
            background: linear-gradient(135deg, #38a169, #48bb78);
        }
        
        .import-btn {
            background: linear-gradient(135deg, #3182ce, #4299e1);
        }
        
        .pdf-btn {
            background: linear-gradient(135deg, #e53e3e, #fc8181);
        }
        
        .excel-btn {
            background: linear-gradient(135deg, #38a169, #68d391);
        }
        
        .sync-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* 编辑模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .modal-form input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .modal-form input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .modal-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .modal-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 480px) {
            .container {
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
            
            .total-amount {
                font-size: 2em;
            }
            
            .tab {
                font-size: 12px;
                padding: 12px 8px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="sync-indicator offline" id="sync-indicator"></div>
    
    <div class="container">
        <div class="header">
            <h1>装修费用计算器</h1>
            <div class="total-amount" id="grand-total">¥0</div>
            <div class="sync-status" id="sync-status"></div>
        </div>
        
        <div class="category-tabs">
            <button class="tab active" onclick="switchTab('furniture')">家电家具</button>
            <button class="tab" onclick="switchTab('renovation')">硬装相关</button>
            <button class="tab" onclick="switchTab('materials')">工装材料</button>
        </div>
        
        <div class="tab-content active" id="furniture-tab">
            <div class="category-summary">
                <h3>家电家具类</h3>
                <div class="category-total" id="furniture-total">¥0</div>
            </div>
            
            <div class="search-box">
                <input type="text" id="furniture-search" placeholder="搜索项目..." oninput="searchItems('furniture')">
            </div>
            
            <div class="filters">
                <button class="filter-btn active" onclick="filterItems('furniture', 'all')">全部</button>
                <button class="filter-btn" onclick="filterItems('furniture', 'high')">高价位</button>
                <button class="filter-btn" onclick="filterItems('furniture', 'medium')">中价位</button>
                <button class="filter-btn" onclick="filterItems('furniture', 'low')">低价位</button>
            </div>
            
            <div class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="furniture-name" placeholder="请输入物品名称">
                    </div>
                    <div class="form-group">
                        <input type="number" id="furniture-price" placeholder="单价">
                    </div>
                    <div class="form-group">
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn" onclick="changeQuantity('furniture', -1)">-</button>
                            <input type="number" id="furniture-quantity" value="1" min="1" class="quantity-input">
                            <button type="button" class="quantity-btn" onclick="changeQuantity('furniture', 1)">+</button>
                        </div>
                    </div>
                </div>
                <button class="add-btn" onclick="addItem('furniture')">添加项目</button>
            </div>
            
            <div class="items-list" id="furniture-items"></div>
        </div>
        
        <div class="tab-content" id="renovation-tab">
            <div class="category-summary">
                <h3>硬装相关</h3>
                <div class="category-total" id="renovation-total">¥0</div>
            </div>
            
            <div class="search-box">
                <input type="text" id="renovation-search" placeholder="搜索项目..." oninput="searchItems('renovation')">
            </div>
            
            <div class="filters">
                <button class="filter-btn active" onclick="filterItems('renovation', 'all')">全部</button>
                <button class="filter-btn" onclick="filterItems('renovation', 'high')">高价位</button>
                <button class="filter-btn" onclick="filterItems('renovation', 'medium')">中价位</button>
                <button class="filter-btn" onclick="filterItems('renovation', 'low')">低价位</button>
            </div>
            
            <div class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="renovation-name" placeholder="请输入项目名称">
                    </div>
                    <div class="form-group">
                        <input type="number" id="renovation-price" placeholder="单价">
                    </div>
                    <div class="form-group">
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn" onclick="changeQuantity('renovation', -1)">-</button>
                            <input type="number" id="renovation-quantity" value="1" min="1" class="quantity-input">
                            <button type="button" class="quantity-btn" onclick="changeQuantity('renovation', 1)">+</button>
                        </div>
                    </div>
                </div>
                <button class="add-btn" onclick="addItem('renovation')">添加项目</button>
            </div>
            
            <div class="items-list" id="renovation-items"></div>
        </div>
        
        <div class="tab-content" id="materials-tab">
            <div class="category-summary">
                <h3>工装材料&工费</h3>
                <div class="category-total" id="materials-total">¥0</div>
            </div>
            
            <div class="search-box">
                <input type="text" id="materials-search" placeholder="搜索项目..." oninput="searchItems('materials')">
            </div>
            
            <div class="filters">
                <button class="filter-btn active" onclick="filterItems('materials', 'all')">全部</button>
                <button class="filter-btn" onclick="filterItems('materials', 'high')">高价位</button>
                <button class="filter-btn" onclick="filterItems('materials', 'medium')">中价位</button>
                <button class="filter-btn" onclick="filterItems('materials', 'low')">低价位</button>
            </div>
            
            <div class="add-form">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="materials-name" placeholder="请输入项目名称">
                    </div>
                    <div class="form-group">
                        <input type="number" id="materials-price" placeholder="单价">
                    </div>
                    <div class="form-group">
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn" onclick="changeQuantity('materials', -1)">-</button>
                            <input type="number" id="materials-quantity" value="1" min="1" class="quantity-input">
                            <button type="button" class="quantity-btn" onclick="changeQuantity('materials', 1)">+</button>
                        </div>
                    </div>
                </div>
                <button class="add-btn" onclick="addItem('materials')">添加项目</button>
            </div>
            
            <div class="items-list" id="materials-items"></div>
        </div>
        
        <div class="stats-section">
            <h3 style="text-align: center; margin-bottom: 15px; color: #333;">装修统计</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-items">0</div>
                    <div class="stat-label">总项目数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avg-price">¥0</div>
                    <div class="stat-label">平均单价</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="most-expensive">¥0</div>
                    <div class="stat-label">最贵项目</div>
                </div>
            </div>
        </div>
        
        <div class="export-section">
            <div class="export-buttons">
                <button class="export-btn" onclick="exportData()">导出文本</button>
                <button class="export-btn pdf-btn" onclick="exportToPDF()">导出PDF</button>
                <button class="export-btn excel-btn" onclick="exportToExcel()">导出Excel</button>
                <button class="export-btn backup-btn" onclick="backupData()">备份数据</button>
                <button class="export-btn import-btn" onclick="importData()">导入数据</button>
                <button class="export-btn sync-btn" onclick="showSyncCode()">GitHub同步</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑模态框 -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">编辑项目</div>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-form">
                <input type="text" id="edit-name" placeholder="项目名称">
                <input type="number" id="edit-price" placeholder="单价" min="0" step="0.01">
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeEditModal()">取消</button>
                    <button class="modal-btn primary" onclick="saveEdit()">保存</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    <input type="file" id="import-file" accept=".json" class="hidden" onchange="handleFileImport(event)">

    <script>
        // 初始数据
        let data = {
            furniture: [
                { name: "羊毛被1.8*2", price: 230, quantity: 1 },
                { name: "小米智能门铃", price: 484, quantity: 1 },
                { name: "小米零火开关", price: 148, quantity: 1 },
                { name: "洗地机", price: 1636, quantity: 1 },
                { name: "电动晾衣架", price: 530, quantity: 1 },
                { name: "小米循环扇", price: 195, quantity: 1 },
                { name: "小米智能猫眼", price: 360, quantity: 1 },
                { name: "电视支架", price: 230, quantity: 1 },
                { name: "水龙头（浴室两个）", price: 356, quantity: 1 },
                { name: "风尊二代pro空调", price: 2150, quantity: 1 },
                { name: "日丰花洒", price: 620, quantity: 1 },
                { name: "小米电视", price: 3280, quantity: 1 },
                { name: "台下水槽", price: 580, quantity: 1 },
                { name: "卡萨帝烟灶", price: 1980, quantity: 1 },
                { name: "美的冰箱&货拉拉运费", price: 808, quantity: 1 },
                { name: "小米音箱&插线板", price: 205, quantity: 1 },
                { name: "蒸烤机", price: 2690, quantity: 1 },
                { name: "抽拉马桶", price: 1252, quantity: 1 },
                { name: "小天鹅洗烘", price: 5000, quantity: 1 },
                { name: "美的风管机", price: 3550, quantity: 1 },
                { name: "洗碗机", price: 2730, quantity: 1 },
                { name: "扫地机", price: 3699, quantity: 1 },
                { name: "日丰厨房单槽", price: 500, quantity: 1 },
                { name: "工业吸尘器", price: 133, quantity: 1 },
                { name: "日丰智能马桶", price: 1104, quantity: 1 },
                { name: "日丰水龙头", price: 200, quantity: 1 },
                { name: "冰箱", price: 5800, quantity: 1 },
                { name: "沙发", price: 6700, quantity: 1 },
                { name: "全屋定制柜子", price: 48000, quantity: 1 }
            ],
            renovation: [
                { name: "封窗", price: 17500, quantity: 1 },
                { name: "微改", price: 22880, quantity: 1 },
                { name: "门改色", price: 2900, quantity: 1 },
                { name: "生活阳台加顶", price: 497, quantity: 1 },
                { name: "踢脚线", price: 1496, quantity: 1 },
                { name: "洗衣台定制", price: 1788, quantity: 1 },
                { name: "阳台石定金", price: 500, quantity: 1 },
                { name: "木地板", price: 14945, quantity: 1 }
            ],
            materials: [
                { name: "风管机铜管", price: 360, quantity: 1 },
                { name: "马桶安装", price: 100, quantity: 1 },
                { name: "浴室柜门&合页", price: 290, quantity: 1 },
                { name: "风管机预埋铜管&打孔", price: 1150, quantity: 1 },
                { name: "电线", price: 28, quantity: 1 },
                { name: "瓦克玻璃胶", price: 85, quantity: 1 },
                { name: "厨房接气管", price: 180, quantity: 1 },
                { name: "门槛石维修", price: 200, quantity: 1 },
                { name: "厨房水槽安装费", price: 170, quantity: 1 },
                { name: "灶具接软管", price: 160, quantity: 1 },
                { name: "燃气保险", price: 200, quantity: 1 },
                { name: "洗碗机安装", price: 66, quantity: 1 },
                { name: "电视安装", price: 240, quantity: 1 },
                { name: "电视加长电源线", price: 58, quantity: 1 },
                { name: "电工加电位", price: 200, quantity: 1 },
                { name: "购买电线", price: 70, quantity: 1 },
                { name: "电灯安装", price: 40, quantity: 1 },
                { name: "马桶花洒安装", price: 200, quantity: 1 },
                { name: "空调高空费", price: 100, quantity: 1 }
            ]
        };

        let currentFilter = { furniture: 'all', renovation: 'all', materials: 'all' };
        let editingItem = null;

        // GitHub Gist 同步管理器
        class GitHubGistSyncManager {
            constructor() {
                this.roomId = this.getRoomId();
                this.gistId = localStorage.getItem('gistId') || null;
                this.githubToken = localStorage.getItem('github_token') || null;
                this.fileName = 'renovation-data.json';
                this.pollInterval = null;
                this.isSyncing = false;
                this.lastSyncTime = parseInt(localStorage.getItem('lastSyncTime') || '0');
                this.debugMode = true;
                this.init();
            }

            log(message, type = 'info') {
                if (this.debugMode) {
                    console.log(`[GitHubSync ${type.toUpperCase()}] ${message}`);
                }
            }

            getRoomId() {
                let roomId = localStorage.getItem('renovationRoomId');
                if (!roomId) {
                    roomId = 'room_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('renovationRoomId', roomId);
                    this.log(`Created new room ID: ${roomId}`);
                } else {
                    this.log(`Using existing room ID: ${roomId}`);
                }
                return roomId;
            }

            async init() {
                this.updateSyncIndicator('offline');
                
                if (!this.gistId || !this.githubToken) {
                    this.showStatus('需要配置GitHub同步', 'warning');
                    this.log('Missing GitHub token or Gist ID');
                    return;
                }

                this.log(`Initializing with Gist ID: ${this.gistId}`);

                try {
                    await this.testConnection();
                    this.startPolling();
                    this.showStatus('GitHub同步已连接');
                    this.updateSyncIndicator('online');
                    this.log('GitHub sync initialized successfully');
                } catch (error) {
                    this.log(`初始化失败: ${error.message}`, 'error');
                    this.showStatus('同步连接失败', 'error');
                    this.updateSyncIndicator('offline');
                }
            }

            async testConnection() {
                this.log('Testing GitHub connection...');
                
                const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                    headers: {
                        'Authorization': `token ${this.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                this.log(`GitHub connection test response: ${response.status}`);

                if (!response.ok) {
                    throw new Error(`GitHub API错误: ${response.status}: ${response.statusText}`);
                }

                const gist = await response.json();
                this.log('GitHub connection test successful');
                return gist;
            }

            startPolling() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                }

                this.log('Starting polling every 15 seconds');

                this.pollInterval = setInterval(async () => {
                    if (navigator.onLine && !this.isSyncing) {
                        await this.checkForUpdates();
                    }
                }, 15000); // 15秒检查一次

                // 立即检查一次
                setTimeout(() => this.checkForUpdates(), 1000);
            }

            async checkForUpdates() {
                if (!this.githubToken || !this.gistId || this.isSyncing) return;

                try {
                    this.log('Checking for updates...');
                    this.updateSyncIndicator('syncing');
                    
                    const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        headers: {
                            'Authorization': `token ${this.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        const gist = await response.json();
                        const fileContent = gist.files[this.fileName];
                        
                        if (fileContent) {
                            const remoteData = JSON.parse(fileContent.content);
                            
                            this.log(`Remote data timestamp: ${remoteData.timestamp}, Local: ${this.lastSyncTime}`);
                            
                            if (remoteData.roomId === this.roomId) {
                                const remoteTimestamp = parseInt(remoteData.timestamp);
                                
                                if (remoteTimestamp > this.lastSyncTime) {
                                    this.log('Remote data is newer, merging...');
                                    this.mergeData(remoteData.data);
                                    this.lastSyncTime = remoteTimestamp;
                                    localStorage.setItem('lastSyncTime', remoteTimestamp.toString());
                                    this.showStatus('数据已从GitHub同步');
                                } else {
                                    this.log('Local data is up to date');
                                }
                            } else {
                                this.log('Room ID mismatch or invalid data structure');
                            }
                        }
                    } else {
                        this.log(`Failed to check updates: ${response.status}`, 'error');
                    }
                    
                    this.updateSyncIndicator('online');
                } catch (error) {
                    this.log(`Update check failed: ${error.message}`, 'error');
                    this.updateSyncIndicator('offline');
                }
            }

            async uploadData() {
                if (!navigator.onLine || !this.githubToken || !this.gistId) {
                    this.log('Upload skipped: offline or not configured');
                    return;
                }

                if (this.isSyncing) {
                    this.log('Upload skipped: already syncing');
                    return;
                }

                try {
                    this.isSyncing = true;
                    this.updateSyncIndicator('syncing');
                    this.log('Uploading data to GitHub...');

                    const timestamp = Date.now();
                    const uploadData = {
                        data: JSON.parse(JSON.stringify(data)), // 深拷贝
                        timestamp: timestamp,
                        roomId: this.roomId,
                        lastModified: new Date().toISOString()
                    };

                    this.log(`Uploading with timestamp: ${timestamp}`);

                    const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${this.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                [this.fileName]: {
                                    content: JSON.stringify(uploadData, null, 2)
                                }
                            }
                        })
                    });

                    if (response.ok) {
                        this.lastSyncTime = timestamp;
                        localStorage.setItem('lastSyncTime', timestamp.toString());
                        this.log('Data uploaded successfully to GitHub');
                        this.showStatus('数据已上传到GitHub');
                        this.updateSyncIndicator('online');
                    } else {
                        const errorText = await response.text();
                        this.log(`Upload failed: ${response.status} - ${errorText}`, 'error');
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    this.log(`Upload error: ${error.message}`, 'error');
                    this.showStatus('数据上传失败', 'error');
                    this.updateSyncIndicator('offline');
                } finally {
                    this.isSyncing = false;
                }
            }

            async setupSync(githubToken) {
                try {
                    this.log(`Setting up GitHub sync with token: ${githubToken.substring(0, 10)}...`);
                    this.githubToken = githubToken;
                    localStorage.setItem('github_token', githubToken);

                    // 创建新的Gist
                    const initialData = {
                        data: JSON.parse(JSON.stringify(data)),
                        timestamp: Date.now(),
                        roomId: this.roomId,
                        lastModified: new Date().toISOString()
                    };

                    this.log('Creating new Gist...');

                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: '装修费用计算器数据同步',
                            public: false,
                            files: {
                                [this.fileName]: {
                                    content: JSON.stringify(initialData, null, 2)
                                }
                            }
                        })
                    });

                    if (response.ok) {
                        const gist = await response.json();
                        this.gistId = gist.id;
                        localStorage.setItem('gistId', this.gistId);
                        localStorage.setItem('lastSyncTime', initialData.timestamp.toString());
                        this.lastSyncTime = initialData.timestamp;
                        
                        this.log(`Gist created successfully: ${this.gistId}`);
                        
                        await this.init();
                        this.showStatus('GitHub同步配置成功！');
                        return { success: true, gistId: this.gistId };
                    } else {
                        const errorText = await response.text();
                        this.log(`Gist creation failed: ${response.status} - ${errorText}`, 'error');
                        throw new Error(`创建Gist失败: ${response.status}`);
                    }
                } catch (error) {
                    this.log(`Setup failed: ${error.message}`, 'error');
                    this.showStatus('GitHub同步配置失败：' + error.message, 'error');
                    return { success: false, error: error.message };
                }
            }

            mergeData(remoteData) {
                try {
                    this.log('Merging remote data...');
                    
                    // 更新全局数据
                    data.furniture = remoteData.furniture || [];
                    data.renovation = remoteData.renovation || [];
                    data.materials = remoteData.materials || [];
                    
                    // 重新渲染界面
                    ['furniture', 'renovation', 'materials'].forEach(category => {
                        renderItems(category);
                    });
                    updateTotals();
                    
                    this.log('Data merged successfully');
                } catch (error) {
                    this.log(`Data merge failed: ${error.message}`, 'error');
                    this.showStatus('数据同步异常', 'error');
                }
            }

            updateSyncIndicator(status) {
                const indicator = document.getElementById('sync-indicator');
                if (indicator) {
                    indicator.className = `sync-indicator ${status}`;
                }
            }

            showStatus(message, type = 'success') {
                const statusEl = document.getElementById('sync-status');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `sync-status ${type}`;
                    setTimeout(() => {
                        if (statusEl.textContent === message) {
                            statusEl.textContent = '';
                            statusEl.className = 'sync-status';
                        }
                    }, 5000);
                }
            }

            getRoomCode() {
                return this.roomId;
            }

            getGistUrl() {
                return this.gistId ? `https://gist.github.com/${this.gistId}` : null;
            }
        }

        // 初始化GitHub同步管理器
        const syncManager = new GitHubGistSyncManager();

        function formatCurrency(amount) {
            return '¥' + amount.toLocaleString();
        }

        function calculateTotal(category) {
            return data[category].reduce((sum, item) => sum + (item.price * item.quantity), 0);
        }

        function calculateGrandTotal() {
            return calculateTotal('furniture') + calculateTotal('renovation') + calculateTotal('materials');
        }

        function updateTotals() {
            const furnitureTotal = calculateTotal('furniture');
            const renovationTotal = calculateTotal('renovation');
            const materialsTotal = calculateTotal('materials');
            const grandTotal = furnitureTotal + renovationTotal + materialsTotal;

            document.getElementById('furniture-total').textContent = formatCurrency(furnitureTotal);
            document.getElementById('renovation-total').textContent = formatCurrency(renovationTotal);
            document.getElementById('materials-total').textContent = formatCurrency(materialsTotal);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);

            updateStats();
        }

        function updateStats() {
            const allItems = [...data.furniture, ...data.renovation, ...data.materials];
            const totalItems = allItems.reduce((sum, item) => sum + item.quantity, 0);
            const grandTotal = calculateGrandTotal();
            
            document.getElementById('total-items').textContent = totalItems;
            document.getElementById('avg-price').textContent = totalItems > 0 ? formatCurrency(Math.round(grandTotal / totalItems)) : '¥0';
            
            const mostExpensive = Math.max(...allItems.map(item => item.price * item.quantity));
            document.getElementById('most-expensive').textContent = formatCurrency(mostExpensive || 0);
        }

        function getPriceLevel(price) {
            if (price >= 3000) return 'high';
            if (price >= 500) return 'medium';
            return 'low';
        }

        function filterItems(category, filter) {
            currentFilter[category] = filter;
            
            // 更新按钮状态
            const buttons = document.querySelectorAll(`#${category}-tab .filter-btn`);
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderItems(category);
        }

        function searchItems(category) {
            renderItems(category);
        }

        function getFilteredItems(category) {
            let items = data[category];
            
            // 搜索过滤
            const searchTerm = document.getElementById(`${category}-search`).value.toLowerCase();
            if (searchTerm) {
                items = items.filter(item => item.name.toLowerCase().includes(searchTerm));
            }
            
            // 价格过滤
            const filter = currentFilter[category];
            if (filter !== 'all') {
                items = items.filter(item => getPriceLevel(item.price * item.quantity) === filter);
            }
            
            return items;
        }

        function renderItems(category) {
            const container = document.getElementById(`${category}-items`);
            const items = getFilteredItems(category);
            container.innerHTML = '';

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state">没有找到匹配的项目</div>';
                return;
            }

            items.forEach((item) => {
                const actualIndex = data[category].indexOf(item);
                const totalPrice = item.price * item.quantity;
                
                const itemElement = document.createElement('div');
                itemElement.className = 'item';
                itemElement.innerHTML = `
                    <div class="item-content">
                        <div class="item-info">
                            <div class="item-name" onclick="editItemName('${category}', ${actualIndex})">${item.name}</div>
                            <div class="item-details">数量: ${item.quantity}</div>
                        </div>
                        <div class="item-price-section">
                            <div class="item-price" onclick="editItemPrice('${category}', ${actualIndex})">${formatCurrency(item.price)}</div>
                            ${item.quantity > 1 ? `<div class="item-total">小计: ${formatCurrency(totalPrice)}</div>` : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <div class="edit-quantity">
                            <button onclick="changeItemQuantity('${category}', ${actualIndex}, -1)">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="changeItemQuantity('${category}', ${actualIndex}, 1)">+</button>
                        </div>
                        <button class="edit-btn" onclick="editItem('${category}', ${actualIndex})">编辑</button>
                        <button class="delete-btn" onclick="deleteItem('${category}', ${actualIndex})">删除</button>
                    </div>
                `;
                container.appendChild(itemElement);
            });
        }

        function changeQuantity(category, delta) {
            const input = document.getElementById(`${category}-quantity`);
            let value = parseInt(input.value) + delta;
            if (value < 1) value = 1;
            input.value = value;
        }

        function changeItemQuantity(category, index, delta) {
            const item = data[category][index];
            item.quantity = Math.max(1, item.quantity + delta);
            renderItems(category);
            updateTotals();
            syncManager.uploadData();
        }

        function switchTab(category) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${category}-tab`).classList.add('active');
        }

        function addItem(category) {
            const nameInput = document.getElementById(`${category}-name`);
            const priceInput = document.getElementById(`${category}-price`);
            const quantityInput = document.getElementById(`${category}-quantity`);
            
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const quantity = parseInt(quantityInput.value) || 1;

            if (!name) {
                showToast('请输入项目名称');
                nameInput.focus();
                return;
            }

            if (isNaN(price) || price <= 0) {
                showToast('请输入有效的价格');
                priceInput.focus();
                return;
            }

            data[category].push({ name, price, quantity });
            
            nameInput.value = '';
            priceInput.value = '';
            quantityInput.value = '1';
            
            renderItems(category);
            updateTotals();
            syncManager.uploadData();
            showToast('项目添加成功');
        }

        function deleteItem(category, index) {
            if (confirm('确定要删除这个项目吗？')) {
                data[category].splice(index, 1);
                renderItems(category);
                updateTotals();
                syncManager.uploadData();
                showToast('项目删除成功');
            }
        }

        // 编辑项目功能
        function editItem(category, index) {
            editingItem = { category, index };
            const item = data[category][index];
            
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-price').value = item.price;
            
            showEditModal();
        }

        function editItemName(category, index) {
            editingItem = { category, index };
            const item = data[category][index];
            
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-price').value = item.price;
            
            showEditModal();
            // 聚焦到名称输入框
            setTimeout(() => {
                document.getElementById('edit-name').focus();
                document.getElementById('edit-name').select();
            }, 100);
        }

        function editItemPrice(category, index) {
            editingItem = { category, index };
            const item = data[category][index];
            
            document.getElementById('edit-name').value = item.name;
            document.getElementById('edit-price').value = item.price;
            
            showEditModal();
            // 聚焦到价格输入框
            setTimeout(() => {
                document.getElementById('edit-price').focus();
                document.getElementById('edit-price').select();
            }, 100);
        }

        function showEditModal() {
            document.getElementById('edit-modal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            editingItem = null;
        }

        function saveEdit() {
            if (!editingItem) return;
            
            const newName = document.getElementById('edit-name').value.trim();
            const newPrice = parseFloat(document.getElementById('edit-price').value);
            
            if (!newName) {
                showToast('请输入项目名称');
                return;
            }
            
            if (isNaN(newPrice) || newPrice <= 0) {
                showToast('请输入有效的价格');
                return;
            }
            
            const { category, index } = editingItem;
            data[category][index].name = newName;
            data[category][index].price = newPrice;
            
            renderItems(category);
            updateTotals();
            closeEditModal();
            syncManager.uploadData();
            showToast('项目修改成功');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // 显示GitHub同步配置
        function showSyncCode() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">GitHub同步设置</div>
                        <button class="close-btn" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-form">
                        <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                            要启用多设备同步，需要配置GitHub Personal Access Token。<br>
                            1. 访问 <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a><br>
                            2. 点击"Generate new token (classic)"<br>
                            3. 勾选"gist"权限并生成token<br>
                            4. 将token输入下方
                        </p>
                        <input type="password" id="github-token-input" placeholder="请输入 GitHub Personal Access Token" style="margin-bottom: 15px;">
                        <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <p style="margin-bottom: 10px; font-weight: bold;">房间代码：</p>
                            <div style="font-family: monospace; font-size: 14px; word-break: break-all; background: white; padding: 10px; border-radius: 4px;">
                                ${syncManager.getRoomCode()}
                            </div>
                        </div>
                        <div class="modal-buttons">
                            <button class="modal-btn secondary" onclick="this.closest('.modal').remove()">取消</button>
                            <button class="modal-btn primary" onclick="setupGitHubSync()">配置同步</button>
                            <button class="modal-btn primary" onclick="copyRoomCode('${syncManager.getRoomCode()}')">复制房间代码</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // 点击外部关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function setupGitHubSync() {
            const githubToken = document.getElementById('github-token-input').value.trim();
            if (!githubToken) {
                showToast('请输入 GitHub Token');
                return;
            }

            // 检查是创建新房间还是加入现有房间
            const setupMode = document.querySelector('input[name="setup-mode"]:checked').value;
            
            if (setupMode === 'join') {
                const existingRoomCode = document.getElementById('existing-room-code').value.trim();
                if (!existingRoomCode) {
                    showToast('请输入房间代码');
                    return;
                }
                joinExistingRoomWithToken(existingRoomCode, githubToken);
            } else {
                // 创建新房间
                syncManager.setupSync(githubToken).then(result => {
                    if (result.success) {
                        document.querySelector('.modal.show').remove();
                        showToast('GitHub同步配置成功！');
                    } else {
                        showToast('配置失败：' + result.error);
                    }
                });
            }
        }

        function joinExistingRoom() {
            const roomCode = document.getElementById('join-room-code').value.trim();
            const token = document.getElementById('join-token').value.trim();
            
            if (!roomCode) {
                showToast('请输入房间代码');
                return;
            }
            
            if (!token) {
                showToast('请输入 GitHub Token');
                return;
            }

            joinExistingRoomWithToken(roomCode, token);
        }

        async function joinExistingRoomWithToken(roomCode, githubToken) {
            try {
                showToast('正在加入房间...');
                
                // 设置新的配置
                localStorage.setItem('renovationRoomId', roomCode);
                localStorage.setItem('github_token', githubToken);
                localStorage.removeItem('gistId'); // 清除旧的Gist ID
                localStorage.removeItem('lastSyncTime'); // 清除同步时间
                
                // 重新初始化同步管理器
                syncManager.roomId = roomCode;
                syncManager.githubToken = githubToken;
                syncManager.gistId = null;
                syncManager.lastSyncTime = 0;
                
                // 尝试查找现有的Gist
                const gistId = await findGistByRoomId(roomCode, githubToken);
                
                if (gistId) {
                    localStorage.setItem('gistId', gistId);
                    syncManager.gistId = gistId;
                    
                    // 重新初始化
                    await syncManager.init();
                    
                    // 强制检查更新
                    syncManager.lastSyncTime = 0;
                    await syncManager.checkForUpdates();
                    
                    document.querySelector('.modal.show').remove();
                    showToast('成功加入房间！数据已同步');
                } else {
                    throw new Error('未找到对应的房间数据');
                }
                
            } catch (error) {
                console.error('加入房间失败:', error);
                showToast('加入房间失败：' + error.message);
            }
        }

        async function findGistByRoomId(roomId, githubToken) {
            try {
                // 获取用户的所有Gist
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('无法获取Gist列表');
                }
                
                const gists = await response.json();
                
                // 查找包含指定房间ID的Gist
                for (const gist of gists) {
                    if (gist.files && gist.files['renovation-data.json']) {
                        try {
                            const fileResponse = await fetch(gist.url, {
                                headers: {
                                    'Authorization': `token ${githubToken}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            });
                            
                            if (fileResponse.ok) {
                                const gistDetail = await fileResponse.json();
                                const fileContent = gistDetail.files['renovation-data.json'].content;
                                const data = JSON.parse(fileContent);
                                
                                if (data.roomId === roomId) {
                                    return gist.id;
                                }
                            }
                        } catch (e) {
                            // 忽略解析错误，继续查找下一个
                            continue;
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('查找Gist失败:', error);
                throw error;
            }
        }

        function copyRoomCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast('房间代码已复制到剪贴板');
            }).catch(() => {
                showToast('复制失败，请手动复制');
            });
        }

        function exportData() {
            let exportText = '装修费用汇总\n\n';
            
            const categories = {
                furniture: '家电家具类',
                renovation: '硬装相关',
                materials: '工装材料&工费'
            };
            
            Object.keys(categories).forEach(category => {
                exportText += `${categories[category]}:\n`;
                data[category].forEach(item => {
                    const total = item.price * item.quantity;
                    exportText += `${item.name}: ${formatCurrency(item.price)} × ${item.quantity} = ${formatCurrency(total)}\n`;
                });
                exportText += `小计: ${formatCurrency(calculateTotal(category))}\n\n`;
            });

            const grandTotal = calculateGrandTotal();
            exportText += `总计: ${formatCurrency(grandTotal)}`;

            if (navigator.share) {
                navigator.share({
                    title: '装修费用汇总',
                    text: exportText
                });
            } else {
                navigator.clipboard.writeText(exportText).then(() => {
                    showToast('数据已复制到剪贴板！');
                }).catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = exportText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast('数据已复制到剪贴板！');
                    } catch (err) {
                        showToast('复制失败，请手动复制');
                        console.log(exportText);
                    }
                    document.body.removeChild(textarea);
                });
            }
        }

        function exportToPDF() {
            if (typeof window.jsPDF === 'undefined') {
                showToast('PDF功能加载中，请稍后再试');
                return;
            }

            try {
                const { jsPDF } = window.jsPDF;
                const doc = new jsPDF();
                
                doc.setFont('helvetica');
                doc.setFontSize(20);
                doc.text('装修费用汇总', 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`生成日期: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
                
                let yPosition = 50;
                const categories = {
                    furniture: '家电家具类',
                    renovation: '硬装相关',
                    materials: '工装材料&工费'
                };
                
                Object.keys(categories).forEach(category => {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text(categories[category], 20, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    
                    data[category].forEach(item => {
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        const total = item.price * item.quantity;
                        const text = `${item.name}: ¥${item.price.toLocaleString()} × ${item.quantity} = ¥${total.toLocaleString()}`;
                        doc.text(text, 25, yPosition);
                        yPosition += 6;
                    });
                    
                    doc.setFont('helvetica', 'bold');
                    const subtotal = calculateTotal(category);
                    doc.text(`小计: ¥${subtotal.toLocaleString()}`, 25, yPosition);
                    yPosition += 15;
                    doc.setFont('helvetica', 'normal');
                });
                
                if (yPosition > 260) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                const grandTotal = calculateGrandTotal();
                doc.text(`总计: ¥${grandTotal.toLocaleString()}`, 105, yPosition, { align: 'center' });
                
                const fileName = `装修费用汇总_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                showToast('PDF导出成功！');
                
            } catch (error) {
                console.error('PDF导出失败:', error);
                showToast('PDF导出失败，请稍后再试');
            }
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                showToast('Excel library not loaded, please refresh and try again');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                const categories = {
                    furniture: 'Furniture & Appliances',
                    renovation: 'Renovation',
                    materials: 'Materials & Labor'
                };
                
                const summaryData = [
                    ['Renovation Cost Summary'],
                    ['Generated Date', new Date().toLocaleDateString()],
                    [''],
                    ['Category', 'Item Name', 'Unit Price', 'Quantity', 'Subtotal']
                ];
                
                Object.keys(categories).forEach(category => {
                    summaryData.push([categories[category], '', '', '', '']);
                    
                    data[category].forEach(item => {
                        const total = item.price * item.quantity;
                        summaryData.push(['', item.name, item.price, item.quantity, total]);
                    });
                    
                    const subtotal = calculateTotal(category);
                    summaryData.push(['', 'Subtotal', '', '', subtotal]);
                    summaryData.push(['']);
                });
                
                const grandTotal = calculateGrandTotal();
                summaryData.push(['', 'Grand Total', '', '', grandTotal]);
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [
                    { wch: 15 }, { wch: 30 }, { wch: 12 }, { wch: 10 }, { wch: 15 }
                ];
                
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
                
                Object.keys(categories).forEach(category => {
                    const categoryData = [
                        [categories[category]],
                        [''],
                        ['Item Name', 'Unit Price', 'Quantity', 'Subtotal']
                    ];
                    
                    data[category].forEach(item => {
                        const total = item.price * item.quantity;
                        categoryData.push([item.name, item.price, item.quantity, total]);
                    });
                    
                    const subtotal = calculateTotal(category);
                    categoryData.push(['']);
                    categoryData.push(['Total', '', '', subtotal]);
                    
                    const ws = XLSX.utils.aoa_to_sheet(categoryData);
                    ws['!cols'] = [
                        { wch: 30 }, { wch: 12 }, { wch: 10 }, { wch: 15 }
                    ];
                    
                    XLSX.utils.book_append_sheet(wb, ws, categories[category].substring(0, 30));
                });
                
                const fileName = `renovation_cost_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showToast('Excel exported successfully!');
                
            } catch (error) {
                console.error('Excel export error:', error);
                showToast('Excel export failed: ' + error.message);
            }
        }

        function backupData() {
            const backupData = {
                data: data,
                timestamp: new Date().toISOString(),
                version: '3.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `装修预算备份_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('备份文件已下载');
        }

        function importData() {
            document.getElementById('import-file').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.data) {
                        data = importedData.data;
                        
                        Object.keys(data).forEach(category => {
                            data[category].forEach(item => {
                                if (!item.quantity) item.quantity = 1;
                            });
                        });
                        
                        ['furniture', 'renovation', 'materials'].forEach(category => {
                            renderItems(category);
                        });
                        updateTotals();
                        syncManager.uploadData();
                        
                        showToast('数据导入成功！');
                    } else {
                        showToast('导入文件格式不正确');
                    }
                } catch (error) {
                    showToast('导入失败：文件格式错误');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // 初始化
        ['furniture', 'renovation', 'materials'].forEach(category => {
            data[category].forEach(item => {
                if (!item.quantity) item.quantity = 1;
            });
            renderItems(category);
        });
        updateTotals();

        // 添加回车键支持
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const target = e.target;
                if (target.id.includes('-name') || target.id.includes('-price')) {
                    const category = target.id.split('-')[0];
                    addItem(category);
                } else if (target.id === 'edit-name' || target.id === 'edit-price') {
                    saveEdit();
                }
            }
        });

        // 模态框点击外部关闭
        document.getElementById('edit-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // 防止页面缩放
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
